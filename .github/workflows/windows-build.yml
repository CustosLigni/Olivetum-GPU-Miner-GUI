name: windows-build

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  build:
    runs-on: windows-2022
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"
          cache: true

      - name: Setup MSYS2 (MinGW-w64)
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          path-type: inherit
          update: true
          install: >-
            mingw-w64-x86_64-gcc

      - name: Build (OlivetumMiner.exe)
        shell: msys2 {0}
        env:
          CGO_ENABLED: "1"
        run: |
          set -euxo pipefail
          mkdir -p dist
          go mod download
          go build -trimpath -ldflags="-H=windowsgui -s -w" -o dist/OlivetumMiner.exe .

      - name: Package zip
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          $zip = Join-Path "dist" "OlivetumMiner-windows-x86_64.zip"
          if (Test-Path $zip) { Remove-Item -Force $zip }
          Compress-Archive -Force -Path (Join-Path "dist" "OlivetumMiner.exe") -DestinationPath $zip
          Write-Host "Created: $zip"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: OlivetumMiner-windows-x86_64
          path: dist/OlivetumMiner-windows-x86_64.zip
